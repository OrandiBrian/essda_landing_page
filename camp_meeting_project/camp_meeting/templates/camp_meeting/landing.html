{% load static %}

<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camp Meeting 2025 - Eden Springs SDA Church</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- link to stylesheet -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">

</head>
<body class="font-sans">
    <!-- Header -->
    <header id="about" class="navbar bg-green-900 text-neutral-content shadow-lg sticky top-0 z-50">
        <div class="navbar-start">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-yellow-500 rounded-lg flex items-center justify-center">
                    <i class="fas fa-fire text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">SDA CHURCH</h1>
                    <p class="text-sm text-yellow-400">EDEN SPRINGS</p>
                </div>
            </div>
        </div>
        
        <div class="navbar-center hidden lg:flex">
            <ul class="menu menu-horizontal px-1">
                <li><a href="#about" class="hover:text-yellow-400">About</a></li>
                <li><a href="#status" class="hover:text-yellow-400">Status</a></li>
                <li><a href="#contribute" class="hover:text-yellow-400">Contribute</a></li>
            </ul>
        </div>
        
        <div class="navbar-end">
            <a class="mr-10 hover:text-yellow-400" href="{% url 'camp_meeting:login' %}" class="hover:text-yellow-400">Login</a>
            <a href="#contribute" class="btn btn-warning btn-sm md:btn-md">
                <i class="fas fa-hand-holding-heart mr-2"></i>
                Give
            </a>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero min-h-screen hero-gradient">
        <div class="hero-content text-center text-white">
            <div class="max-w-4xl">
                <h1 class="text-5xl md:text-7xl font-bold mb-8 animate-pulse">
                    CAMP MEETING 2025
                </h1>
                
                <div class="flex items-center justify-center mb-8">
                    <i class="fas fa-calendar-alt text-yellow-400 mr-3 text-xl"></i>
                    <p class="text-xl md:text-2xl">17th - 24th August, 2025</p>
                </div>
                
                <!-- Countdown Timer -->
                <div class="grid grid-cols-4 gap-4 max-w-md mx-auto mb-8" id="countdown">
                    <div class="countdown-digit rounded-lg p-4 text-center">
                        <div class="text-3xl md:text-4xl font-bold" id="days">--</div>
                        <div class="text-sm">DAYS</div>
                    </div>
                    <div class="countdown-digit rounded-lg p-4 text-center">
                        <div class="text-3xl md:text-4xl font-bold" id="hours">--</div>
                        <div class="text-sm">HRS</div>
                    </div>
                    <div class="countdown-digit rounded-lg p-4 text-center">
                        <div class="text-3xl md:text-4xl font-bold" id="minutes">--</div>
                        <div class="text-sm">MIN</div>
                    </div>
                    <div class="countdown-digit rounded-lg p-4 text-center">
                        <div class="text-3xl md:text-4xl font-bold" id="seconds">--</div>
                        <div class="text-sm">SEC</div>
                    </div>
                </div>
                
                <p class="text-lg mb-8 opacity-90">
                    Join us for a transformative spiritual experience at Eden Springs Church Grounds
                </p>
                
                <a href="#contribute" class="btn btn-warning btn-lg">
                    <i class="fas fa-donate mr-2"></i>
                    Contribute Now
                </a>
            </div>
        </div>
    </section>

    <!-- Contribution Status Section -->
    <section id="status" class="py-16 bg-base-100">
        <div class="container mx-auto px-4">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-base-content mb-4">Contribution Status</h2>
                <p class="text-lg text-base-content/70">Together we're building something beautiful. See how our church family is coming together to make this Camp Meeting possible.</p>
            </div>
            
            <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto mb-12">
                <div class="stat bg-base-200 rounded-lg shadow-lg">
                    <div class="stat-title">Funds Raised</div>
                    <div class="stat-value text-success" id="total-raised">Ksh. {{ total_contributions|floatformat:0 }}</div>
                    <div class="stat-desc">Total contributions received</div>
                </div>
                
                <div class="stat bg-base-200 rounded-lg shadow-lg">
                    <div class="stat-title">Days Left</div>
                    <div class="stat-value text-warning" id="days-left">{{ days_left }}</div>
                    <div class="stat-desc">Until Camp Meeting 2025</div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="max-w-4xl mx-auto mb-12">
                <div class="flex justify-between text-sm mb-2">
                    <span>Ksh. 0</span>
                    <span class="font-bold text-xl">{{ percentage_raised|floatformat:0 }}%</span>
                    <span>Ksh. {{ target_amount|floatformat:0 }}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div class="progress-custom h-4 rounded-full transition-all duration-1000" 
                         style="width: {{ percentage_raised }}%"></div>
                </div>
            </div>
            
            <!-- Latest Contribution -->
            {% if latest_contribution %}
            <div class="max-w-2xl mx-auto">
                <div class="card bg-gradient-to-r from-yellow-400 to-orange-500 text-white shadow-xl">
                    <div class="card-body text-center">
                        <h3 class="card-title justify-center text-2xl">Latest Contribution</h3>
                        <div class="text-4xl font-bold">Ksh. {{ latest_contribution.amount|floatformat:0 }}</div>
                        <p class="text-lg">{{ latest_contribution.first_name }} - Thank you!</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Recent Contributions -->
    <section class="py-16 bg-base-200">
        <div class="container mx-auto px-4">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-base-content mb-4">Recent Contributors</h2>
                <p class="text-lg text-base-content/70">Thank you for your generous giving. Be blessed!</p>
            </div>
            
            <div class="max-w-2xl mx-auto">
                {% if latest_contributions %}
                    {% for contribution in latest_contributions %}
                    <div class="flex justify-between items-center p-4 bg-base-100 rounded-lg mb-4 shadow-">
                        <div class="flex items-center">
                            <div class="avatar placeholder mr-4">
                                <div class="bg-neutral text-neutral-content rounded-full w-12">
                                    <span>{{ contribution.first_name.0 }}</span>
                                </div>
                            </div>
                            <span class="font-medium">{{ contribution.first_name }}</span>
                        </div>
                        <div class="text-success font-bold">Ksh. {{ contribution.amount|floatformat:0 }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center text-base-content/50">
                    <i class="fas fa-heart text-4xl mb-4"></i>
                    <p>Be the first to contribute!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Contribution Form Section -->
    <section id="contribute" class="py-16 bg-base-100">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold text-base-content mb-4">Make a Contribution</h2>
                    <p class="text-lg text-base-content/70">Your generosity is a testament to God's love working through you. Every contribution helps create lasting memories and spiritual experiences for our entire church family.</p>
                </div>
                
                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Contribution Form -->
                    <div class="card bg-base-200 shadow-xl">
                        <div class="card-body">
                            <h3 class="card-title text-2xl mb-6">Contribute via M-Pesa</h3>
                            
                            <form id="contribution-form" method="POST" class="space-y-4">
                                {% csrf_token %}
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">Full Name</span>
                                    </label>
                                    <input type="text" name="full_name" placeholder="Enter full name" 
                                           class="input input-bordered w-full" required>
                                </div>

                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">Email</span>
                                    </label>
                                    <input type="text" name="email" placeholder="example@gmail.com" 
                                           class="input input-bordered w-full" required>
                                </div>
                                
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">M-Pesa Phone Number</span>
                                    </label>
                                    <input type="tel" name="phone_number" placeholder="254xxxxxxxxx" 
                                           pattern="^(\+254|254|0)[17]\d{8}$"
                                           class="input input-bordered w-full" required>
                                </div>
                                
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium">Contribution Amount (KES)</span>
                                    </label>
                                    <input type="number" name="amount" placeholder="Enter amount" 
                                           min="1" step="1" class="input input-bordered w-full" required>
                                </div>
                                
                                <div class="flex flex-wrap gap-2 mb-4">
                                    {% comment %} <button type="button" class="btn btn-outline btn-sm amount-btn" data-amount="100">100</button> {% endcomment %}
                                    <button type="button" class="btn btn-outline btn-sm amount-btn" data-amount="500">500</button>
                                    <button type="button" class="btn btn-outline btn-sm amount-btn" data-amount="1000">1000</button>
                                    <button type="button" class="btn btn-outline btn-sm amount-btn" data-amount="2000">2000</button>
                                    <button type="button" class="btn btn-outline btn-sm amount-btn" data-amount="5000">5000</button>
                                </div>
                                
                                <button type="submit" class="btn btn-warning w-full btn-lg" id="submit-btn">
                                    <i class="fas fa-mobile-alt mr-2"></i>
                                    Pay via M-Pesa
                                </button>
                            </form>
                            
                            <div class="alert alert-info mt-4">
                                <i class="fas fa-info-circle"></i>
                                <span>You will receive an M-Pesa prompt on your phone to complete the payment.</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Information -->
                    <div class="space-y-6">
                        <div class="card bg-success text-success-content shadow-xl">
                            <div class="card-body">
                                <h3 class="card-title">Payment Information</h3>
                                <div class="space-y-2">
                                    <p><strong>Paybill:</strong> NCBA Bank</p>
                                    <p><strong>Account:</strong> Camp2025</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card bg-info text-info-content shadow-xl">
                            <div class="card-body">
                                <h3 class="card-title">
                                    <i class="fas fa-heart mr-2"></i>
                                    Thank You
                                </h3>
                                <p>Your generosity is a testament to God's love working through you. Every contribution helps create lasting memories and spiritual experiences for our entire church family.</p>
                            </div>
                        </div>
                        
                        {% comment %} <div class="stats stats-vertical shadow">
                            <div class="stat">
                                <div class="stat-title">Event Dates</div>
                                <div class="stat-value text-lg">Aug 17-24, 2025</div>
                                <div class="stat-desc">Eden Springs Church Grounds</div>
                            </div>
                            <div class="stat">
                                <div class="stat-title">Theme</div>
                                <div class="stat-value text-lg">"Renewal & Revival"</div>
                                <div class="stat-desc">Spiritual transformation</div>
                            </div>
                        </div> {% endcomment %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer footer-center p-10 bg-neutral text-neutral-content">
        <div>
            <div class="w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-fire text-white text-2xl"></i>
            </div>
            <p class="font-bold text-xl">Eden Springs SDA Church</p>
            <p>A community of believers committed to growing in faith, fellowship, and service to God and our neighbors.</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-4xl">
            <div>
                <h3 class="font-bold text-lg mb-2">Service Times</h3>
                <div class="text-sm space-y-1">
                    <p><strong>Sabbath Services</strong></p>
                    <p>Sabbath School: 9:00am - 9:45am</p>
                    <p>Divine Service: 10:00am - 12:00pm</p>
                    <p>Afternoon Service: 2:00pm - 4:00pm</p>
                </div>
            </div>
            
            <div>
                <h3 class="font-bold text-lg mb-2">Camp Meeting 2025</h3>
                <div class="text-sm space-y-1">
                    <p><strong>Dates:</strong> August 17-24, 2025</p>
                    <p><strong>Theme:</strong> "Renewal & Revival"</p>
                    <p><strong>Venue:</strong> Eden Springs Church Grounds</p>
                </div>
            </div>
            
            <div>
                <h3 class="font-bold text-lg mb-2">Connect With Us</h3>
                <div class="flex justify-center space-x-4">
                    <a href="#" class="btn btn-circle btn-outline btn-sm">
                        <i class="fab fa-youtube"></i>
                    </a>
                    <a href="#" class="btn btn-circle btn-outline btn-sm">
                        <i class="fab fa-facebook"></i>
                    </a>
                </div>
                <div class="text-sm mt-2 space-y-1">
                    <p><i class="fas fa-map-marker-alt mr-2"></i>Umwala, Nairobi, Kenya</p>
                    <p><i class="fas fa-phone mr-2"></i>+254 700 000 000</p>
                    <p><i class="fas fa-envelope mr-2"></i>edenspringssdachurch.org</p>
                </div>
            </div>
        </div>
        
        <div class="divider"></div>
        <div>
            <p>© 2025 Eden Springs SDA Church. All rights reserved.</p>
        </div>
    </footer>

    <!-- Loading Modal -->
    <dialog id="loading_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Processing Payment</h3>
            <p class="py-4">Please wait while we process your contribution...</p>
            <div class="flex justify-center">
                <span class="loading loading-spinner loading-lg text-warning"></span>
            </div>
        </div>
    </dialog>

    <!-- Success Modal -->
    <dialog id="success_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg text-success">
                <i class="fas fa-check-circle mr-2"></i>
                Payment Initiated
            </h3>
            <p class="py-4">An M-Pesa payment request has been sent to your phone. Please complete the transaction to finish your contribution.</p>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-success">OK</button>
                </form>
            </div>
        </div>
    </dialog>

    <!-- Error Modal -->
    <dialog id="error_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg text-error">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Payment Failed
            </h3>
            <p class="py-4" id="error_message">Something went wrong. Please try again.</p>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-error">Close</button>
                </form>
            </div>
        </div>
    </dialog>

    <!-- javascript -->
    <script>
        // Countdown Timer
        function updateCountdown() {
            const eventDate = new Date('2025-08-17T00:00:00').getTime();
            const now = new Date().getTime();
            const timeLeft = eventDate - now;

            if (timeLeft > 0) {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                document.getElementById('days').textContent = String(days).padStart(2, '0');
                document.getElementById('hours').textContent = String(hours).padStart(2, '0');
                document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
                document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
            } else {
                document.getElementById('days').textContent = '00';
                document.getElementById('hours').textContent = '00';
                document.getElementById('minutes').textContent = '00';
                document.getElementById('seconds').textContent = '00';
            }
        }

        // Update countdown every second
        setInterval(updateCountdown, 1000);
        updateCountdown(); // Initial call

        // Amount buttons
        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const amount = this.dataset.amount;
                document.querySelector('input[name="amount"]').value = amount;
                
                // Remove active class from all buttons
                document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('btn-warning'));
                // Add active class to clicked button
                this.classList.add('btn-warning');
            });
        });

        // Form submission
        document.getElementById('contribution-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = {
                full_name: formData.get('full_name'),
                email: formData.get('email'),
                phone_number: formData.get('phone_number'),
                amount: parseFloat(formData.get('amount'))
            };

            // Validate form
            if (!data.full_name || !data.email || !data.phone_number || !data.amount) {
                document.getElementById('error_message').textContent = 'Please fill in all fields';
                document.getElementById('error_modal').showModal();
                return;
            }
            if (data.amount < 1) {
                document.getElementById('error_message').textContent = 'Amount must be at least Ksh. 1';
                document.getElementById('error_modal').showModal();
                return;
            }

            document.getElementById('loading_modal').showModal();
            try {
                const response = await fetch('{% url "camp_meeting:contribute" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                document.getElementById('loading_modal').close();

                if (result.success) {
                    document.getElementById('success_modal').showModal();
                    this.reset();
                    document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('btn-warning'));
                    setTimeout(updateStats, 3000);
                    if (result.checkout_request_id) {
                        pollStkStatus(result.checkout_request_id);
                    }
                } else {
                    document.getElementById('error_message').textContent = result.message || 'Payment failed. Please try again.';
                    document.getElementById('error_modal').showModal();
                }
            } catch (error) {
                document.getElementById('loading_modal').close();
                document.getElementById('error_message').textContent = 'Network error. Please check your connection and try again.';
                document.getElementById('error_modal').showModal();
            }
        });

        // Update stats every 20 seconds
        setInterval(updateStats, 20000);

        // Smooth scrolling for navigation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Update statistics
        async function updateStats() {
            try {
                const response = await fetch('{% url "camp_meeting:stats" %}');
                const data = await response.json();
                
                // Update displayed values
                document.getElementById('total-raised').textContent = `Ksh. ${data.total_contributions.toLocaleString()}`;
                document.getElementById('days-left').textContent = data.countdown.days;
                
                // Update progress bar
                const progressBar = document.querySelector('.progress-custom');
                progressBar.style.width = `${data.percentage_raised}%`;
                
                // Update countdown
                document.getElementById('days').textContent = String(data.countdown.days).padStart(2, '0');
                document.getElementById('hours').textContent = String(data.countdown.hours).padStart(2, '0');
                document.getElementById('minutes').textContent = String(data.countdown.minutes).padStart(2, '0');
                document.getElementById('seconds').textContent = String(data.countdown.seconds).padStart(2, '0');
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Real-time form validation
        document.querySelector('input[name="amount"]').addEventListener('input', function(e) {
            const value = parseFloat(e.target.value);
            const submitBtn = document.getElementById('submit-btn');
            
            if (value < 1) {
                submitBtn.disabled = true;
                submitBtn.classList.add('btn-disabled');
            } else {
                submitBtn.disabled = false;
                submitBtn.classList.remove('btn-disabled');
            }
        });

        // Add loading animation to progress bar
        document.addEventListener('DOMContentLoaded', function() {
            const progressBar = document.querySelector('.progress-custom');
            progressBar.style.width = '0%';
            
            setTimeout(() => {
                progressBar.style.width = '{{ percentage_raised }}%';
            }, 500);
        });

        // Add entrance animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate-fade-in-up');
                }
            });
        }, observerOptions);

        // Observe all cards and sections
        document.querySelectorAll('.card, .stat, section').forEach(el => {
            observer.observe(el);
        });

        function pollStkStatus(checkoutRequestID) {
            let reqcount = 0;
            const maxAttempts = 15;

            const statusContainer = document.getElementById("status-container");
            const statusMessage = document.getElementById("status-message");
            const loadingSpinner = document.getElementById("loading-spinner");

            const interval = setInterval(async () => {
                reqcount += 1;

                try {
                    const response = await fetch("/stk_status/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                        },
                        body: JSON.stringify({ checkout_request_id: checkoutRequestID }),
                    });

                    if (!response.ok) {
                        throw new Error("Failed to fetch status");
                    }

                    const data = await response.json();
                    console.log("STK Status:", data);

                    // Handling pending status (ResultCode -1 or Status 'Pending')
                    if (data.status && (data.status.ResultCode === -1 || data.status.Status === "Pending")) {
                        // Still waiting for user interaction, keep polling
                        if (statusMessage) {
                            statusMessage.innerHTML = `
                                <div class="text-warning">
                                Awaiting user confirmation on your phone...
                                </div>`;
                        }
                    } else if (data.status && data.status.ResultCode === 0) {
                        // ✅ SUCCESS
                        clearInterval(interval);
                        if (loadingSpinner) loadingSpinner.style.display = "none";
                        if (statusMessage) {
                            statusMessage.innerHTML = `
                                <div class="text-success">
                                Payment successful! ✅
                                </div>`;
                        }
                    } else if (data.status && data.status.ResultCode) {
                        // ❌ FAILURE
                        clearInterval(interval);
                        if (loadingSpinner) loadingSpinner.style.display = "none";
                        if (statusMessage) {
                            statusMessage.innerHTML = `
                                <div class="text-error">
                                ${data.status.ResultDesc || "Payment failed. Try again."}
                                </div>`;
                        }
                    }

                    if (reqcount >= maxAttempts) {
                        // ⏳ TIMEOUT
                        clearInterval(interval);
                        if (loadingSpinner) loadingSpinner.style.display = "none";
                        if (statusMessage) {
                            statusMessage.innerHTML = `
                                <div class="alert alert-warning">You took too long to confirm the payment. Try again later.</div>`;
                        }
                    }

                } catch (error) {
                    console.error(error);
                }
            }, 2000);
        }

    </script>
    {% comment %} <script src="{% static 'js/index.js' %}"></script> {% endcomment %}
    
</body>
</html>